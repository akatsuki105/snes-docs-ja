# レジスタ

## 420Bh - MDMAEN - GDMAチャネルレジスタ (W)

```
  Bit n DMAチャネルn で GDMA (0=無効, 1=有効)
```

このレジスタに0以外の値を書き込むと、GDMAが直ちに（数clkサイクル後に）開始されます。

CPUは転送中、一時停止します。GDMA転送はHDMA転送により中断されることがあります。

複数のbitがセットされている場合、別々の転送がチャネル 0=先頭～7=末尾 の順に実行されます。

各bitは、チャネルの転送が完了すると自動的にクリアされます。

HDMAEN で HDMA として使用しているチャネルは、GDMA に使用しないでください。

## 420Ch - HDMAEN - HDMAチャネルレジスタ (W)

```
  Bit n DMAチャネルn で HDMA (0=無効, 1=有効)
```

MDMAEN の　HDMA版 です。

このレジスタのbitを立てると、bitに対応するDMAチャネルで HBlank時 にHDMA転送が実装されます。

## 43x0h - DMAPx - GDMA/HDMA設定レジスタ (R/W)

```
  GDMA:
    Bit 0-2   転送ユニット(詳細は後述)
                0: 1x1 (Bバス: xx)
                1: 2x1 (Bバス: xx -> xx+1)
                2: 1x2 (Bバス: xx -> xx)
                3: 2x2 (Bバス: xx -> xx -> xx+1 -> xx+1)
                4: 4x1 (Bバス: xx -> xx+1 -> xx+2 -> xx+3)
                5: ??? (Bバス: xx -> xx+1 -> xx -> xx+1)
                6: 1x2 (2と同じ)
                7: 2x2 (3と同じ)
    Bit 3-4   Aバスのアドレス増加
                0: インクリメント
                1: 固定
                2: デクリメント
                3: 固定
    Bit 5-6   不使用
    Bit 7     転送方向 (0=Aバス->Bバス, 1=Bバス->Aバス)

  HDMA:
    Bit 0-2   転送ユニット (内容はGDMAと同じ)
    Bit 3-5   不使用
    Bit 6     テーブルモード (0=直接, 1=間接)
    Bit 7     転送方向 (0=Aバス->Bバス, 1=Bバス->Aバス)
```

転送モード(bit0-2)の `NxM` は 同じBバスアドレスに対して`M`回処理を行ったのちアドレスをインクリメント、これを`N`回繰り返す ということを表しています。

擬似コードで表すと次のようになります。

```c
// Aバス -> Bバス の場合
void transfer_unit() {
  b = bus.b;

  for (n = 0; n < N; n++) {
    for (m = 0; m < M; m++) {
      val = read(bus.a);
      write(0x2100+b, val);
      bus.a += INCREMENT;
    }

    b++;
  }
}
```

## 43x1h - BBADx - Bバスアドレス (R/W)

```
  Bit 0-7 Bバスアドレス (0xNN = 0x21NN)
```

GDMAでは基本的に `04h=OAM, 18h=VRAM, 22h=CGRAM, 80h=WRAM`　のどれかになります。

HDMAでは大抵の場合、PPUレジスタのどれかを指します。

## 43x2h/43x3h/43x4h - A1Tx - Aバスアドレス (R/W)

このレジスタではAバスの指すアドレスを指定します。

HDMAの場合は[HDMAテーブル](hdma.md)の開始アドレス(エントリ0)を指します。

```
  GDMA:
    Bit 0-15   Aバスアドレス (bit0-15, 転送が進むごとに変化(DMAPx.3-4)する)
    Bit 16-23  Aバスアドレス (bit16-23, DMAPx.3-4の影響を受けず、ずっと固定)

  HDMA:
    Bit 0-15   HDMAテーブル開始アドレス (ずっと固定、43x8h/43x9h へとリロードされる)
    Bit 16-23  HDMAテーブル開始アドレス (ずっと固定、43x8h/43x9h のバンク番号)
```

## 43x5h/43x6h/43x7h - DASx - GDMA転送サイズ/間接HDMAアドレス (R/W)

間接HDMAの場合、0x43x7 だけはプログラマが転送前に設定しておく必要があります。<sup>[1](#indirect_bank)</sup>

```
  GDMA:
    Bit 0-15   残りの転送バイトサイズ (0のときは0x10000)
                 転送が進むと共に減っていき、0になると転送終了
                   例: 残り5バイトで転送ユニットが4バイトのとき、ユニット1個と2個目のユニットの1バイト目が転送される
    Bit 16-23  不使用

  HDMA(直接):
    Bit 0-23   不使用 (転送するデータはテーブルから直接読み込まれます)

  HDMA(間接):
    Bit 0-15   Current CPU-Bus Data Address (automatically loaded from the Table)
    Bit 16-23  Current CPU-Bus Data Address Bank   (this must be set by software)
```

## 43x8h/43x9h - A2Ax - HDMAテーブルアドレス (R/W)

リロード時に、自動的に`A1Tx`(0x43x2)の値に設定されます。

現在の[HDMAテーブル](hdma.md)アドレスを示します。転送の進行によってインクリメントされていきます。

テーブルアドレスの bit16-23(バンク) は A1Tx の bit16-23 になります。

```
  GDMA:
    Bit 0-15 不使用

  HDMA:
    Bit 0-15 現在のHDMAテーブルアドレス    (43x2h/43x3h の値でリロードされる)
               転送の進行によってインクリメントされる
    -        現在のHDMAテーブルのバンク番号 (=43x4h)
```

## 43xAh - NTRLx - HDMAテーブルヘッダ (R/W)

[HDMAテーブル](hdma.md)の現在のエントリのヘッダが入っています。

リロード時に自動で設定されるため、プログラマがこのレジスタを変更する必要はありません。

```
  GDMA:
    Bit 0-7 不使用
  HDMA:
    Bit 0-7 ヘッダ (後述)
```

## 43xBh - UNUSEDx - 用途なし (R/W)

```
  Bit 0-7 用途なし
```

使われていませんが、値を自由に読み書きできます。そのため、高速RAMとして使用可能です。(ただし、memfillの固定DMAソースアドレスとしては使用不可)

このレジスタに値を格納しても、転送には何の影響もないようです。（値はそのまま残され、DMAや直接・間接HDMAによって変更されることはありません）

## 43xCh..43xEh - 不使用 (W)

使われていません。書き込んでも何も起こらないようです。

読み取ると、オープンバスからのゴミ値が返ってきます。

## 43xFh - MIRRx - 43xBhミラー (R/W)

`43xBh`のミラーです。

## 注釈

<sup id="indirect_bank">1: 0x43x4 と同じバンクにある場合は，0x43x7 に書き込む必要はありません。</sup>