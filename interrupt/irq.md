# IRQ

スーファミの IRQ は PPU によってのみリクエストされます。

IRQ は PPU が特定の場所を描画した瞬間にリクエストされます。

X座標が満たされた時の HIRQ、 Y座標が満たされた時の VIRQ 、XY両方の座標が満たされたときの HVIRQ の3種類のIRQがあります。

## IRQの無効化

CPUのIフラグをセットすることでIRQを無効化できます。

また、`NMITIMEN.4-5` を 0 にすることでもIRQを無効化できます。

## IRQフラグ

IRQがリクエストされると `TIMEUP.7`(0x4211) がセットされます。

```
  TIMEUP(R):
    Bit 0-6   不使用
    Bit 7     IRQフラグ (0=通常, 1=リクエスト発生)
```

IRQフラグ(bit7)は、このレジスタから読み出した後、自動的にクリアされます。ただしIRQ条件が真であるまさにその時（4-8マスターサイクルの間続く）に読み出した場合はCPUは`bit7=1`を受け取りますが、bit7はクリアされません。

IRQフラグ(bit7)は、`NMITIMEN.4-5`を 0 にしてIRQを無効にするときにも自動的にクリアされます。

エッジ依存のNMIハンドラと違って、レベル依存のIRQハンドラはIRQを必ずアクノリッジしなければいけません。さもないと、RTIの直後に割り込みが再びリクエストされます。([詳細](README.md))

## HIRQ

HIRQは水平方向の描画座標(Hカウンタ)が、`HTIME`(0x4207,4208)で設定したX座標に到達した際にリクエスト(TIMEUP.7をセット)されます。`(x, y) = (HTIME, any)`

ただし、`NMITIMEN.4-5` を 1 にしておく必要があります。

```
  HTIME(W):
    Bit 0-8   HIRQ座標 (0..339) (+/-1 in long/short lines) (0=左端)
    Bit 9-15  不使用
```

## VIRQ

VIRQは垂直方向の描画座標(Vカウンタ)が、`VTIME`(0x4209,420A)で設定したY座標に到達した際にリクエスト(TIMEUP.7をセット)されます。`(x, y) = (0, VTIME)`

ただし、`NMITIMEN.4-5` を 2 にしておく必要があります。

```
  VTIME(W):
    Bit 0-8   VIRQ座標 (0..261) (+1 in interlace) (0=上端)
    Bit 9-15  不使用
```

## HVIRQ

HVIRQ は 描画座標が `(x, y) = (HTIME, VTIME)` となったときにリクエスト(TIMEUP.7をセット)されます。

ただし、`NMITIMEN.4-5` を 3 にしておく必要があります。

## IRQシーケンス

IRQピンがLowになると割り込みシーケンスの開始が要求されます。

IRQが無効化されていないなら、現在実行中の命令終了後に割り込みを認識して、割り込みシーケンスが開始されます。

IRQはレベル依存の入力<sup>[1](#level)</sup>なので、前回の割り込み以降、割り込みソースがクリアされていない場合は割り込みが発生します。また、割り込み認識前に割り込みソースをクリアした場合は、割り込みは発生しません。

IRQが無視されず認識されたとき、以下の処理が行われます。

```go
  if REG.P[E] = 1 {
    REG.P[B] = 0;
  }
  if REG.P[E] = 0 {
    push8(REG.PB);
  }
  push16(REG.PC);
  push8(REG.P);
  REG.P[D], REG.P[I] = 0, 1;
  REG.PB, REG.PC = 0x00, VEC_IRQ; // VEC_IRQ: WORD[0xFFEE] or WORD[0xFFFE]
```

<sup id="level">1: HighからLowの切り替わりでなくLowであることでトリガーされる</sup>
